<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Simulador de Escolha de vagas de SVA - EAOF 2025 - Turma Petrus</title>
  <style>
    :root{
      --bg:#0b1220; --card:#0f1a30; --muted:#8aa0bd; --text:#eaf0ff;
      --accent:#3aa2ff; --ok:#76d275; --warn:#ffb74d; --err:#ff6e6e; --border:#1f2a44;
    }
    *{box-sizing:border-box}
    body{margin:0; font:400 16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif; background:var(--bg); color:var(--text)}
    .container{max-width:1100px; margin:0 auto; padding:20px}
    header h1{margin:8px 0 4px; font-size:26px}
    header .subtitle{color:var(--muted)}
    .card{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px; margin:14px 0; box-shadow:0 6px 16px rgba(0,0,0,.25)}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .space-between{justify-content:space-between}
    label{min-width:260px}
    select, button{ background:#0c1528; color:var(--text); border:1px solid var(--border); border-radius:10px; padding:8px 12px; }
    select:disabled, button:disabled{opacity:.5; cursor:not-allowed}
    button{cursor:pointer}
    button.primary{border-color:var(--accent)}
    button.ghost{background:transparent}
    .status{margin:8px 0; color:var(--muted)}
    .status.ok{color:var(--ok)}
    .status.warn{color:var(--warn)}
    .status.err{color:var(--err)}
    .table-wrapper{overflow:auto; border:1px solid var(--border); border-radius:10px}
    table{width:100%; min-width:740px; border-collapse:separate; border-spacing:0}
    th,td{padding:8px 10px; border-bottom:1px solid var(--border); white-space:nowrap; text-align:left}
    thead th{position:sticky; top:0; background:#12203a}
    tbody tr:nth-child(even){background:#0e172b}
    .small{font-size:12px; color:var(--muted)}
    .pill{display:inline-block; padding:2px 8px; border:1px solid var(--border); border-radius:999px; font-size:12px; margin-left:8px}
  </style>
</head>
<body>
  <header class="container">
    <h1>Simulador Escolha de vagas de SVA - EAOF 2025 - Turma Petrus</h1>
    <p class="subtitle">Dados carregados automaticamente de <code>classificacao.csv</code> e <code>vagas.csv</code> (repositÃ³rio). A escolha respeita a ordem de CLASSIFICACAO.</p>
  </header>

  <main class="container">
    <section class="card">
      <h2>SeleÃ§Ã£o</h2>
      <div class="row">
        <label for="selPessoa">Seu nome (NOME_GUERRA)</label>
        <select id="selPessoa" disabled>
          <option value="">â€” carregandoâ€¦ â€”</option>
        </select>
        <span id="tagTurno" class="pill">vez: â€”</span>
      </div>
      <div class="row">
        <label for="selVaga">Vaga disponÃ­vel (LOCALIDADE Â· ODGSA Â· OM)</label>
        <select id="selVaga" disabled>
          <option value="">â€” carregandoâ€¦ â€”</option>
        </select>
        <button id="btnConfirmar" class="primary" disabled>Confirmar escolha</button>
      </div>
      <p id="statusTurno" class="status">Carregando dadosâ€¦</p>
      <div class="row">
        <button id="btnExportar" class="ghost" disabled>Exportar resultados (CSV)</button>
        <button id="btnAdmin" class="ghost">Admin</button>
        <button id="btnUndo" class="ghost" style="display:none">Desfazer Ãºltima</button>
        <button id="btnReset" class="ghost" style="display:none">Reiniciar escolhas</button>
      </div>
      <p id="statusLoad" class="status small">â€”</p>
    </section>

    <section class="card">
      <div class="row space-between">
        <h2>Resultados parciais</h2>
        <span id="resumo" class="small">0/0 escolhas concluÃ­das</span>
      </div>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th># CLASSIFICACAO</th>
              <th>NOME_GUERRA</th>
              <th>LOCALIDADE</th>
              <th>ODGSA</th>
              <th>OM</th>
              <th>Data/Hora</th>
            </tr>
          </thead>
          <tbody id="tbodyResultados"></tbody>
        </table>
      </div>
    </section>
  </main>

  <footer class="container small">Dados persistem localmente (localStorage). Apenas administrador pode desfazer e reiniciar.</footer>

  <script>
    // ===== ConfiguraÃ§Ãµes =====
    const ADMIN_PIN = '0138'; // ðŸ” PIN solicitado
    const CLASSIF_URL = 'classificacao.csv'; // relativo ao site
    const VAGAS_URL   = 'vagas.csv';         // relativo ao site

    // ===== Utilidades CSV =====
    function detectSeparator(text){ const firstLine=(text.split(/\r?\n/).find(l=>l.trim())||''); const c=(firstLine.match(/,/g)||[]).length; const s=(firstLine.match(/;/g)||[]).length; return s>c?';':','; }
    function parseCSV(text, sep){ const rows=[]; let row=[], cur='', inQ=false; for(let i=0;i<text.length;i++){ const ch=text[i], nx=text[i+1]; if(ch==='"'){ if(inQ && nx==='"'){cur+='"'; i++;} else inQ=!inQ; } else if(ch===sep && !inQ){ row.push(cur); cur=''; } else if((ch==='\n'||ch==='\r')&&!inQ){ if(cur!==''||row.length){row.push(cur); rows.push(row); row=[]; cur='';} if(ch==='\r'&&nx==='\n') i++; } else { cur+=ch; } } if(cur!==''||row.length){row.push(cur); rows.push(row);} return rows; }
    function normHeader(h){ return String(h||'').trim().toUpperCase(); }
    function escapeHtml(s){ return String(s??'').replaceAll('&','&amp;').replaceAll('<','&lt').replaceAll('>','&gt;').replaceAll('"','&quot;'); }
    function escapeAttr(s){ return escapeHtml(s).replaceAll('"','&quot;'); }

    // ===== Estado/PersistÃªncia =====
    const state = { pessoas:[], vagas:[], atribuicoes:[] };
    const LS_KEY='eaof2025_sva_pages_v2';
    function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
    function load(){ try{ const s=localStorage.getItem(LS_KEY); if(s){ const o=JSON.parse(s); if(o){ state.pessoas=o.pessoas||[]; state.vagas=o.vagas||[]; state.atribuicoes=o.atribuicoes||[]; } } }catch(e){} }

    // ===== DOM =====
    const els={ selPessoa:document.getElementById('selPessoa'), selVaga:document.getElementById('selVaga'), btnConfirmar:document.getElementById('btnConfirmar'), statusTurno:document.getElementById('statusTurno'), statusLoad:document.getElementById('statusLoad'), tagTurno:document.getElementById('tagTurno'), tbodyResultados:document.getElementById('tbodyResultados'), resumo:document.getElementById('resumo'), btnExportar:document.getElementById('btnExportar'), btnAdmin:document.getElementById('btnAdmin'), btnUndo:document.getElementById('btnUndo'), btnReset:document.getElementById('btnReset') };

    // ===== Fetch de dados do repositÃ³rio =====
    async function fetchCsv(url){
      const res = await fetch(url, { cache: 'no-store' });
      if(!res.ok) throw new Error(`Falha ao carregar ${url}: HTTP ${res.status}`);
      const text = await res.text();
      const sep = detectSeparator(text);
      const rows = parseCSV(text, sep).filter(r=>r.some(c=>String(c).trim()!==''));
      return rows;
    }

    async function loadRemoteData(){
      els.statusLoad.textContent = 'Carregando classificacao.csv e vagas.csvâ€¦';
      try{
        const [pRows, vRows] = await Promise.all([ fetchCsv(CLASSIF_URL), fetchCsv(VAGAS_URL) ]);
        // Pessoas
        const pHeaders = pRows[0].map(normHeader);
        const iClass = pHeaders.indexOf('CLASSIFICACAO');
        const iNome  = pHeaders.indexOf('NOME_GUERRA');
        if(iClass<0 || iNome<0) throw new Error('classificacao.csv sem CLASSIFICACAO/NOME_GUERRA');
        const pessoas = pRows.slice(1).map(r=>({ nome:String(r[iNome]||'').trim(), classificacao:Number(String(r[iClass]||'').trim()) })).filter(p=>p.nome && Number.isFinite(p.classificacao));
        pessoas.sort((a,b)=>a.classificacao-b.classificacao || a.nome.localeCompare(b.nome));
        // Vagas (agora SEM remover as ocupadas; apenas marcamos como indisponÃ­veis)
        const vHeaders = vRows[0].map(normHeader);
        const iLoc = vHeaders.indexOf('LOCALIDADE');
        const iOdg = vHeaders.indexOf('ODGSA');
        const iOm  = vHeaders.indexOf('OM');
        if(iLoc<0 || iOdg<0 || iOm<0) throw new Error('vagas.csv sem LOCALIDADE/ODGSA/OM');
        const vagas = vRows.slice(1).map(r=>{
          const localidade=String(r[iLoc]||'').trim();
          const odgsa=String(r[iOdg]||'').trim();
          const om=String(r[iOm]||'').trim();
          if(!localidade||!odgsa||!om) return null;
          return {localidade, odgsa, om, label:`${localidade} Â· ${odgsa} Â· ${om}`};
        }).filter(Boolean);

        state.pessoas = pessoas;
        state.vagas   = vagas; // mantÃ©m todas as vagas, disponÃ­veis ou nÃ£o
        save();
        els.statusLoad.textContent = `Dados prontos (pessoas: ${pessoas.length}; vagas: ${vagas.length}).`;
        els.statusLoad.className = 'status ok';
        repopulateSelPessoa();
        repopulateSelVaga();
        renderResultados();
        updateControlsForPessoa();
      }catch(err){
        els.statusLoad.textContent = String(err.message||err);
        els.statusLoad.className = 'status err';
      }
    }

    // ===== LÃ³gica de vez =====
    function proximoDaVez(){ const escolhidos=new Set(state.atribuicoes.map(a=>a.nome)); for(const p of state.pessoas){ if(!escolhidos.has(p.nome)) return p; } return null; }
    function isPessoaNaVez(nome){ const prox=proximoDaVez(); return prox && prox.nome===nome; }
    function getPessoa(nome){ return state.pessoas.find(p=>p.nome===nome); }

    // ===== UI: selects =====
    function repopulateSelPessoa(){
      const sel=els.selPessoa; sel.innerHTML='';
      const prox = proximoDaVez();
      const options = state.pessoas.map(p=>{
        const isTurn = prox && p.nome===prox.nome;
        const chosen = state.atribuicoes.some(a=>a.nome===p.nome);
        const label = `${escapeHtml(p.nome)} (class. ${p.classificacao})${chosen?' â€” escolhido':''}`;
        return `<option value="${escapeAttr(p.nome)}" ${isTurn? '' : 'disabled'} ${chosen?'data-chosen="1"':''}>${label}</option>`;
      }).join('');
      sel.innerHTML = `<option value="">${prox? 'Selecione seu nome' : 'ConcluÃ­do'}</option>` + options;
      sel.disabled = !prox; // sÃ³ habilita quando hÃ¡ alguÃ©m na vez
      els.tagTurno.textContent = prox ? `vez: ${prox.nome} (#${prox.classificacao})` : 'vez: â€” (concluÃ­do)';
    }

    function repopulateSelVaga(){
      const sel=els.selVaga; sel.innerHTML='';
      const ocupadas = new Set(state.atribuicoes.map(a=>`${a.localidade}||${a.odgsa}||${a.om}`));
      const options = state.vagas.map(v=>{
        const key = `${v.localidade}||${v.odgsa}||${v.om}`;
        const taken = ocupadas.has(key);
        return `<option value="${escapeAttr(key)}" ${taken? 'disabled' : ''}>${escapeHtml(v.label)}${taken?' (indisponÃ­vel)':''}</option>`;
      }).join('');
      sel.innerHTML = '<option value="">â€” selecione â€”</option>' + options;
      sel.disabled = state.vagas.length===0 || !els.selPessoa.value || !isPessoaNaVez(els.selPessoa.value);
    }

    // ===== Resultados =====
    function renderResultados(){
      const rows=state.atribuicoes.slice().sort((a,b)=>a.classificacao-b.classificacao||a.ts-b.ts);
      els.tbodyResultados.innerHTML = rows.map(a=>{
        const ts=new Date(a.ts).toLocaleString();
        return `<tr><td>${a.classificacao}</td><td>${escapeHtml(a.nome)}</td><td>${escapeHtml(a.localidade)}</td><td>${escapeHtml(a.odgsa)}</td><td>${escapeHtml(a.om)}</td><td>${ts}</td></tr>`;
      }).join('');
      const prox=proximoDaVez();
      els.resumo.textContent = `${state.atribuicoes.length}/${state.pessoas.length} concluÃ­das â€” vagas restantes: ${state.vagas.length - state.atribuicoes.length}`;
      els.statusTurno.className = 'status '+(prox? 'warn':'ok');
      els.statusTurno.textContent = prox ? `Agora Ã© a vez de ${prox.nome} (CLASSIFICACAO ${prox.classificacao}).` : 'Todas as escolhas foram concluÃ­das.';
      els.btnExportar.disabled = state.atribuicoes.length===0;
    }

    // ===== Eventos =====
    els.selPessoa.addEventListener('change', ()=>{
      updateControlsForPessoa();
    });

    function updateControlsForPessoa(){
      const nome=els.selPessoa.value; const naVez=!!nome && isPessoaNaVez(nome);
      els.selVaga.disabled = !naVez || state.vagas.length===0;
      els.btnConfirmar.disabled = !naVez || !els.selVaga.value;
      repopulateSelVaga();
    }

    els.selVaga.addEventListener('change', ()=>{
      els.btnConfirmar.disabled = !els.selPessoa.value || !isPessoaNaVez(els.selPessoa.value) || !els.selVaga.value;
    });

    els.btnConfirmar.addEventListener('click', ()=>{
      const nome=els.selPessoa.value; const vKey=els.selVaga.value; if(!nome||!vKey) return;
      if(!isPessoaNaVez(nome)) return alert('NÃ£o Ã© a sua vez.');
      const [localidade,odgsa,om]=vKey.split('||'); const p=getPessoa(nome);
      state.atribuicoes.push({ nome:p.nome, classificacao:p.classificacao, localidade, odgsa, om, ts:Date.now() });
      save();
      els.selPessoa.value='';
      repopulateSelPessoa();
      repopulateSelVaga();
      renderResultados();
      updateControlsForPessoa();
      alert(`Escolha registrada: ${p.nome} â†’ ${localidade} Â· ${odgsa} Â· ${om}`);
    });

    // ===== Exportar / Admin / Desfazer / Reset =====
    els.btnExportar.addEventListener('click', ()=>{
      const header=['CLASSIFICACAO','NOME_GUERRA','LOCALIDADE','ODGSA','OM','TIMESTAMP'];
      const lines=[header.join(',')].concat(state.atribuicoes.map(a=>[
        a.classificacao, '"'+a.nome.replaceAll('"','""')+'"', '"'+a.localidade.replaceAll('"','""')+'"', '"'+a.odgsa.replaceAll('"','""')+'"', '"'+a.om.replaceAll('"','""')+'"', new Date(a.ts).toISOString()
      ].join(',')));
      const blob=new Blob([lines.join('\n')+'\n'], {type:'text/csv;charset=utf-8'});
      const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='escolhas_eaof2025.csv'; a.click(); setTimeout(()=>URL.revokeObjectURL(url), 800);
    });

    function requireAdmin(msg){ const pin = prompt(msg||'PIN do administrador:'); return pin===ADMIN_PIN; }

    els.btnAdmin.addEventListener('click', ()=>{
      if(requireAdmin('PIN do administrador:')){
        alert('Admin habilitado. BotÃµes Desfazer/Reiniciar disponÃ­veis.');
        els.btnUndo.style.display='inline-block';
        els.btnReset.style.display='inline-block';
      } else {
        alert('PIN incorreto.');
      }
    });

    els.btnUndo.addEventListener('click', ()=>{
      if(!requireAdmin('Confirme o PIN para desfazer a Ãºltima escolha:')) return;
      if(state.atribuicoes.length===0) return alert('NÃ£o hÃ¡ escolhas para desfazer.');
      const ultima = state.atribuicoes[state.atribuicoes.length-1];
      if(!confirm(`Desfazer a Ãºltima escolha?\n${ultima.classificacao} - ${ultima.nome}\n${ultima.localidade} Â· ${ultima.odgsa} Â· ${ultima.om}`)) return;
      state.atribuicoes.pop();
      save();
      repopulateSelPessoa();
      repopulateSelVaga();
      renderResultados();
      updateControlsForPessoa();
      alert('Ãšltima escolha desfeita.');
    });

    els.btnReset.addEventListener('click', ()=>{
      if(!requireAdmin('Confirme o PIN para reiniciar:')) return;
      if(!confirm('Tem certeza que deseja limpar todas as escolhas e recarregar os dados?')) return;
      state.atribuicoes=[]; save();
      loadRemoteData();
    });

    // ===== Init =====
    load();
    loadRemoteData();
  </script>
</body>
</html>
